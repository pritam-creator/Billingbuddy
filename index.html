<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surjya Bakery - Login</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    body {
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #ff9966, #ff5e62);
    }
    
    .login-box {
      background: white;
      padding: 40px 25px;
      border-radius: 22px;
      text-align: center;
      width: 320px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    /* ðŸ”¥ Logo Style */
    .logo {
      width: 90px;
      margin-bottom: 15px;
    }
    
    h2 {
      margin-bottom: 25px;
      color: #ff5e62;
      font-weight: 700;
    }
    
    .pin-container {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 22px;
    }
    
    .pin-input {
      width: 55px;
      height: 60px;
      border: 2px solid #eee;
      border-radius: 14px;
      text-align: center;
      font-size: 22px;
      font-weight: 600;
      outline: none;
      transition: 0.2s;
    }
    
    .pin-input:focus {
      border-color: #ff5e62;
      box-shadow: 0 0 8px rgba(255, 94, 98, 0.3);
    }
    
    button {
      width: 100%;
      padding: 13px;
      border: none;
      border-radius: 14px;
      background: linear-gradient(135deg, #ff9966, #ff5e62);
      color: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.9;
    }
    
    button:disabled {
      background: #999;
      cursor: not-allowed;
    }
    
    .link {
      margin-top: 15px;
      font-size: 14px;
      color: #ff5e62;
      cursor: pointer;
    }
    
    .message {
      margin-top: 10px;
      font-size: 13px;
      min-height: 18px;
    }
  </style>
</head>

<body>
  
  <div class="login-box" id="loginBox">

    <!-- âœ… Added Logo -->
    <img src="https://raw.githubusercontent.com/pritam-creator/billingbuddy-assets/refs/heads/main/Untitled.png" class="logo">

    <h2>Surjya Bakery</h2>
    
    <div class="pin-container">
      <input maxlength="1" class="pin-input" type="number" inputmode="numeric">
      <input maxlength="1" class="pin-input" type="number" inputmode="numeric">
      <input maxlength="1" class="pin-input" type="number" inputmode="numeric">
      <input maxlength="1" class="pin-input" type="number" inputmode="numeric">
    </div>
    
    <button id="loginBtn" onclick="login()">Login</button>
    <p class="link" onclick="goReset()">Reset PIN?</p>
    <div class="message" id="message"></div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBjETFSgZsMDw1JRI0fIcUNMCMOHxBMaLA",
      authDomain: "billingbuddy-551f9.firebaseapp.com",
      projectId: "billingbuddy-551f9",
      storageBucket: "billingbuddy-551f9.firebasestorage.app",
      messagingSenderId: "287026017084",
      appId: "1:287026017084:web:aae879570ad706e5a2a439"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    const inputs = document.querySelectorAll(".pin-input");
    const message = document.getElementById("message");
    const loginBtn = document.getElementById("loginBtn");
    
    let attempts = 0;
    let lockedUntil = null;
    
    // Allow only single digit & auto move
    inputs.forEach((input, index) => {
      input.addEventListener("input", () => {
        input.value = input.value.replace(/[^0-9]/g, '').slice(0, 1);
        
        if (input.value && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
        
        // Auto login when 4 digits entered
        let filled = [...inputs].every(i => i.value.length === 1);
        if (filled) {
          login();
        }
      });
      
      input.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !input.value && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });
    
    // Already logged in
    if (sessionStorage.getItem("loggedIn") === "true") {
      window.location.href = "dashboard.html";
    }
    
    window.login = async function() {
      
      if (lockedUntil && Date.now() < lockedUntil) {
        let sec = Math.ceil((lockedUntil - Date.now()) / 1000);
        showError("Locked. Try again in " + sec + "s");
        return;
      }
      
      if (!navigator.onLine) {
        showError("No internet connection");
        return;
      }
      
      loginBtn.disabled = true;
      message.style.color = "#555";
      message.innerText = "Checking...";
      
      let pin = "";
      inputs.forEach(i => pin += i.value);
      
      if (pin.length !== 4) {
        showError("Enter 4 digit PIN");
        loginBtn.disabled = false;
        return;
      }
      
      try {
        const docRef = doc(db, "settings", "admin");
        const docSnap = await getDoc(docRef);
        
        if (!docSnap.exists()) {
          showError("Admin not configured");
          loginBtn.disabled = false;
          return;
        }
        
        const savedPin = String(docSnap.data().pin);
        
        if (pin === savedPin) {
          message.style.color = "green";
          message.innerText = "Login Successful âœ“";
          sessionStorage.setItem("loggedIn", "true");
          
          setTimeout(() => {
            window.location.href = "dashboard.html";
          }, 800);
          
        } else {
          attempts++;
          if (attempts >= 3) {
            lockedUntil = Date.now() + 30000; // 30 sec lock
            showError("Too many attempts. Locked 30s");
          } else {
            showError("Wrong PIN");
          }
          loginBtn.disabled = false;
        }
        
      } catch (error) {
        showError("Connection Error");
        loginBtn.disabled = false;
      }
    };
    
    function showError(text) {
      message.style.color = "#e74c3c";
      message.innerText = text;
      inputs.forEach(i => i.value = "");
      inputs[0].focus();
    }
    
    window.goReset = function() {
      window.location.href = "reset-pin.html";
    };
  </script>
  
</body>
</html>