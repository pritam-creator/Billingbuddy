<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cart - Surjya Bakery</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,sans-serif;}
body{background:#f2f3f7;padding-bottom:160px;}

.header{
padding:18px;
background:linear-gradient(135deg,#ff9966,#ff5e62);
color:white;
font-size:20px;
font-weight:600;
text-align:center;
position:sticky;
top:0;
}

.cart-item{
background:white;
margin:15px;
padding:15px;
border-radius:14px;
box-shadow:0 4px 10px rgba(0,0,0,0.05);
}

.item-top{
display:flex;
justify-content:space-between;
margin-bottom:10px;
}

.item-name{font-size:15px;font-weight:600;}
.item-price{font-weight:600;}

.controls{
display:flex;
justify-content:space-between;
align-items:center;
}

.qty-box{
display:flex;
align-items:center;
gap:10px;
}

.qty-btn{
width:28px;
height:28px;
border:none;
border-radius:6px;
background:#ff5e62;
color:white;
font-weight:bold;
cursor:pointer;
}

.remove{
font-size:12px;
color:#e74c3c;
background:none;
border:none;
cursor:pointer;
}

.total{
margin:20px 15px;
font-size:18px;
font-weight:700;
text-align:right;
}

.checkout{
position:fixed;
bottom:70px;
left:15px;
right:15px;
background:#2ecc71;
color:white;
text-align:center;
padding:16px;
font-size:18px;
border-radius:30px;
font-weight:600;
box-shadow:0 5px 15px rgba(0,0,0,0.15);
cursor:pointer;
}

.empty{
text-align:center;
margin-top:40px;
color:#777;
}
</style>
</head>

<body>

<div class="header">ðŸ›’ Cart</div>

<div id="cartList"></div>
<div class="total" id="totalAmount"></div>
<div class="checkout" onclick="checkout()">Checkout</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, addDoc, serverTimestamp, query, where } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBjETFSgZsMDw1JRI0fIcUNMCMOHxBMaLA",
  authDomain: "billingbuddy-551f9.firebaseapp.com",
  projectId: "billingbuddy-551f9",
  storageBucket: "billingbuddy-551f9.firebasestorage.app",
  messagingSenderId: "287026017084",
  appId: "1:287026017084:web:aae879570ad706e5a2a439"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const cartList = document.getElementById("cartList");
const totalAmount = document.getElementById("totalAmount");

let cartDocs = [];
let currentUser = null;

/* ========================= */
/* AUTH CHECK */
onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUser = user;
    render();
  }else{
    alert("Please login first");
    window.location.replace("index.html");
  }
});

/* ========================= */
/* RENDER CART */
async function render(){

  cartList.innerHTML="";
  totalAmount.innerText="";
  let total = 0;

  const q = query(
    collection(db,"cart"),
    where("userId","==",currentUser.uid)
  );

  const querySnapshot = await getDocs(q);
  cartDocs = [];

  if(querySnapshot.empty){
    cartList.innerHTML="<div class='empty'>Your cart is empty</div>";
    return;
  }

  querySnapshot.forEach((docSnap)=>{
    let data = docSnap.data();

    // If old cart item has no qty, fix it
    if(!data.qty){
      updateDoc(doc(db,"cart",docSnap.id),{qty:1});
      data.qty = 1;
    }

    cartDocs.push({id:docSnap.id,...data});
  });

  cartDocs.forEach((item,index)=>{

    let itemTotal = item.price * item.qty;
    total += itemTotal;

    cartList.innerHTML += `
    <div class="cart-item">
      <div class="item-top">
        <div class="item-name">${item.name}</div>
        <div class="item-price">â‚¹ ${itemTotal}</div>
      </div>

      <div class="controls">
        <div class="qty-box">
          <button class="qty-btn" onclick="changeQty(${index},-1)">-</button>
          <span>${item.qty}</span>
          <button class="qty-btn" onclick="changeQty(${index},1)">+</button>
        </div>

        <button class="remove" onclick="removeItem(${index})">Remove</button>
      </div>
    </div>
    `;
  });

  totalAmount.innerText="Total: â‚¹ "+total;
}

/* ========================= */
window.changeQty = async function(index,change){

  let item = cartDocs[index];
  let newQty = item.qty + change;

  if(newQty <= 0){
    await deleteDoc(doc(db,"cart",item.id));
  }else{
    await updateDoc(doc(db,"cart",item.id),{qty:newQty});
  }

  render();
};

/* ========================= */
window.removeItem = async function(index){
  let item = cartDocs[index];
  await deleteDoc(doc(db,"cart",item.id));
  render();
};

/* ========================= */
window.checkout = async function(){

  if(cartDocs.length === 0){
    alert("Cart is empty");
    return;
  }

  let total = 0;
  cartDocs.forEach(item=>{
    total += item.price * item.qty;
  });

  await addDoc(collection(db,"orders"),{
    userId: currentUser.uid,
    items: cartDocs,
    total: total,
    createdAt: serverTimestamp()
  });

  for(let item of cartDocs){
    await deleteDoc(doc(db,"cart",item.id));
  }

  alert("Order Placed Successfully ðŸ”¥");
  render();
};

</script>

</body>
</html>